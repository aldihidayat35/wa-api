<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auto-Logging Riwayat Pesan</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .log-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        .log-entry {
            background: white;
            border-left: 4px solid #0d6efd;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .log-entry.success {
            border-left-color: #28a745;
        }
        .log-entry.error {
            border-left-color: #dc3545;
        }
        .log-time {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .log-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .log-desc {
            font-size: 0.95rem;
            color: #495057;
        }
        .log-meta {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
        }
        .badge-custom {
            font-size: 0.75rem;
            padding: 4px 8px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>üß™ Test Auto-Logging Riwayat Pesan</h2>
        <p class="text-muted">Halaman ini untuk memverifikasi bahwa setiap pesan otomatis tercatat di database</p>

        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìä Statistik Logs</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 id="totalLogs" class="text-primary">-</h3>
                            <small class="text-muted">Total Logs</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 id="messageLogs" class="text-success">-</h3>
                            <small class="text-muted">Pesan Terkirim</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 id="errorLogs" class="text-danger">-</h3>
                            <small class="text-muted">Errors</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <button id="refreshBtn" class="btn btn-sm btn-primary">üîÑ Refresh</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">üìã Riwayat Pesan Terbaru (10 Terakhir)</h5>
            </div>
            <div class="card-body">
                <div id="logsContainer" class="log-container">
                    <div class="text-center text-muted">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <p class="mt-2">Loading logs...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-4">
            <h6>‚ÑπÔ∏è Cara Test:</h6>
            <ol class="mb-0">
                <li>Buka halaman <a href="send-message.html" target="_blank">Send Message</a></li>
                <li>Kirim pesan text atau gambar</li>
                <li>Kembali ke halaman ini dan klik tombol <strong>üîÑ Refresh</strong></li>
                <li>Verifikasi bahwa pesan yang dikirim tercatat di riwayat</li>
            </ol>
        </div>

        <div class="alert alert-success mt-3">
            <h6>‚úÖ Fitur Auto-Logging:</h6>
            <ul class="mb-0">
                <li><strong>Pesan Text:</strong> Isi pesan, penerima, waktu pengiriman</li>
                <li><strong>Gambar:</strong> Caption, filename, penerima, waktu</li>
                <li><strong>Errors:</strong> Pesan error, nomor tujuan, waktu</li>
                <li><strong>Bulk Messages:</strong> Setiap pesan dicatat individual</li>
            </ul>
        </div>
    </div>

    <script>
        const logsContainer = document.getElementById('logsContainer')
        const totalLogsEl = document.getElementById('totalLogs')
        const messageLogsEl = document.getElementById('messageLogs')
        const errorLogsEl = document.getElementById('errorLogs')
        const refreshBtn = document.getElementById('refreshBtn')

        // Load logs from database
        async function loadLogs() {
            try {
                // Use Apache URL (Laragon default port 80)
                const response = await fetch('http://localhost/Baileys/api/logs/get.php?limit=10')
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`)
                }

                const data = await response.json()
                
                if (data.success && data.data.logs) {
                    displayLogs(data.data.logs)
                    updateStats(data.data.logs)
                } else {
                    logsContainer.innerHTML = '<div class="alert alert-warning">Tidak ada logs ditemukan</div>'
                }
            } catch (error) {
                logsContainer.innerHTML = `<div class="alert alert-danger">Error loading logs: ${error.message}</div>`
            }
        }

        // Display logs
        function displayLogs(logs) {
            if (logs.length === 0) {
                logsContainer.innerHTML = '<div class="alert alert-info">Belum ada riwayat pesan. Coba kirim pesan dari halaman Send Message.</div>'
                return
            }

            logsContainer.innerHTML = logs.map(log => {
                const metadata = typeof log.metadata === 'string' ? JSON.parse(log.metadata) : log.metadata
                const timestamp = new Date(log.created_at).toLocaleString('id-ID')
                const typeClass = log.log_type === 'error' ? 'error' : 'success'
                const typeLabel = log.log_type === 'error' ? 'danger' : (log.log_type === 'message' ? 'success' : 'info')
                
                let metaInfo = []
                if (metadata.recipient) metaInfo.push(`üìû ${metadata.recipient}`)
                if (metadata.messageType) metaInfo.push(`üìù ${metadata.messageType}`)
                if (metadata.sessionId) metaInfo.push(`üîë ${metadata.sessionId}`)
                if (metadata.messageContent) metaInfo.push(`üí¨ "${metadata.messageContent.substring(0, 50)}${metadata.messageContent.length > 50 ? '...' : ''}"`)
                if (metadata.caption) metaInfo.push(`üí¨ Caption: "${metadata.caption}"`)
                if (metadata.filename) metaInfo.push(`üìé ${metadata.filename}`)
                if (metadata.errorMessage) metaInfo.push(`‚ö†Ô∏è ${metadata.errorMessage}`)
                
                return `
                    <div class="log-entry ${typeClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="log-title">
                                    <span class="badge bg-${typeLabel} badge-custom me-2">${log.log_type.toUpperCase()}</span>
                                    ${log.title}
                                </div>
                                <div class="log-desc">${log.description}</div>
                                ${metaInfo.length > 0 ? `<div class="log-meta">${metaInfo.join(' ‚Ä¢ ')}</div>` : ''}
                            </div>
                            <div class="log-time ms-3">${timestamp}</div>
                        </div>
                    </div>
                `
            }).join('')
        }

        // Update statistics
        function updateStats(logs) {
            const total = logs.length
            const messages = logs.filter(log => log.log_type === 'message').length
            const errors = logs.filter(log => log.log_type === 'error').length
            
            totalLogsEl.textContent = total
            messageLogsEl.textContent = messages
            errorLogsEl.textContent = errors
        }

        // Refresh button
        refreshBtn.addEventListener('click', () => {
            logsContainer.innerHTML = `
                <div class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <p class="mt-2">Refreshing logs...</p>
                </div>
            `
            loadLogs()
        })

        // Auto-load on page load
        loadLogs()

        // Auto-refresh every 10 seconds
        setInterval(loadLogs, 10000)
    </script>
</body>
</html>
